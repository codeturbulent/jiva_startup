<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Custom SVG Shape Crop</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        cursor: auto; /* show cursor */
      }
      canvas {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <canvas id="mainCanvas"></canvas>
    <canvas id="preview" width="1000" height="1000"></canvas>

    <script>
      const cropSize = 200;

      const mainCanvas = document.getElementById("mainCanvas");
      const previewCanvas = document.getElementById("preview");
      const mainCtx = mainCanvas.getContext("2d");
      const previewCtx = previewCanvas.getContext("2d");

      const sourceImage = new Image();
      const distortionMap = new Image();

      sourceImage.crossOrigin = "anonymous";
      distortionMap.crossOrigin = "anonymous";

      sourceImage.src =
        "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1950&q=80";
      distortionMap.src =
        "http://192.168.1.9:5500/jiva_startup/Jiva/assets/flame_02.png"; // Replace with your distortion image

      const distortionCanvas = document.createElement("canvas");
      distortionCanvas.width = cropSize;
      distortionCanvas.height = cropSize;
      const distortionCtx = distortionCanvas.getContext("2d");
      var svgPath;
      fetch(
        "http://192.168.1.9:5500/jiva_startup/Jiva/assets/glass-cursor-blob.svg"
      )
        .then((res) => res.text())
        .then((svgText) => {
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
          const pathElement = svgDoc.querySelector("path");

          const svgPathString = pathElement.getAttribute("d");
          svgPath = new Path2D(svgPathString);

          // Now use `svgPath` in clip()
        });

      let lastCropX = 0,
        lastCropY = 0;

      function drawWithDistortion(dstCtx, sourceCtx) {
        const upscale = 1;
        const size = cropSize;
        const bigSize = size * upscale;

        // Upscaled buffer
        const bigCanvas = document.createElement("canvas");
        bigCanvas.width = bigSize;
        bigCanvas.height = bigSize;
        const bigCtx = bigCanvas.getContext("2d");

        const srcData = sourceCtx.getImageData(0, 0, size, size);
        const mapData = distortionCtx.getImageData(0, 0, size, size);
        const dstData = bigCtx.createImageData(bigSize, bigSize);

        for (let y = 0; y < bigSize; y++) {
          for (let x = 0; x < bigSize; x++) {
            const sx = Math.floor(x / upscale);
            const sy = Math.floor(y / upscale);
            const i = (sy * size + sx) * 4;

            const dx = (mapData.data[i] - 128) / 10;
            const dy = (mapData.data[i + 1] - 128) / 10;

            const srcX = Math.max(0, Math.min(size - 1, sx + dx));
            const srcY = Math.max(0, Math.min(size - 1, sy + dy));
            const srcI = (Math.floor(srcY) * size + Math.floor(srcX)) * 4;

            const di = (y * bigSize + x) * 4;
            dstData.data[di + 0] = srcData.data[srcI + 0];
            dstData.data[di + 1] = srcData.data[srcI + 1];
            dstData.data[di + 2] = srcData.data[srcI + 2];
            dstData.data[di + 3] = 255;
          }
        }

        bigCtx.putImageData(dstData, 0, 0);

        // Clear and clip destination
        dstCtx.clearRect(0, 0, size, size);
        dstCtx.save();
        dstCtx.beginPath();
        dstCtx.clip(svgPath);

        // Draw with smoothing and scaling down
        dstCtx.drawImage(bigCanvas, 0, 0, size, size);

        dstCtx.restore();
      }

      Promise.all([
        new Promise((res) => (sourceImage.onload = res)),
        new Promise((res) => (distortionMap.onload = res)),
      ]).then(() => {
        mainCanvas.width = window.innerWidth;
        mainCanvas.height = window.innerHeight;
        mainCtx.drawImage(
          sourceImage,
          0,
          0,
          mainCanvas.width,
          mainCanvas.height
        );

        distortionCtx.drawImage(distortionMap, 0, 0, cropSize, cropSize);
      });

      document.addEventListener("mousemove", (e) => {
        const scaleX = sourceImage.width / mainCanvas.width;
        const scaleY = sourceImage.height / mainCanvas.height;

        lastCropX = e.clientX * scaleX - cropSize / 2;
        lastCropY = e.clientY * scaleY - cropSize / 2;

        previewCanvas.style.left = `${e.pageX - cropSize / 2}px`;
        previewCanvas.style.top = `${e.pageY - cropSize / 2}px`;

        const bufferCanvas = document.createElement("canvas");
        bufferCanvas.width = cropSize;
        bufferCanvas.height = cropSize;
        const bufferCtx = bufferCanvas.getContext("2d");

        bufferCtx.drawImage(
          sourceImage,
          lastCropX,
          lastCropY,
          cropSize,
          cropSize,
          0,
          0,
          cropSize,
          cropSize
        );

        drawWithDistortion(previewCtx, bufferCtx);
      });
    </script>
  </body>
</html>
